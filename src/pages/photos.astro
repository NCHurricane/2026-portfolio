---
// src/pages/photos.astro
import Layout from '../layouts/Layout.astro';
import photos from '../data/photos.json';
---

<Layout title="Photo Gallery | Chuck Copeland">

    <section class="page-header">
        <div class="container">
            <h1 transition:name="hero-name">Photo Gallery</h1>
            <p class="text-muted">Moments I have captured in the moment using smartphones, drones and digital cameras.
            </p>
            <div class="header-socials">
                <span class="label">More on:</span>
                <a href="https://www.instagram.com/chuck_copeland/" target="_blank" class="social-link">
                    <i class="fab fa-instagram"></i> Instagram
                </a>
                <a href="https://bsky.app/profile/@chuckcopeland.com" target="_blank" class="social-link">
                    <i class="fab fa-bluesky"></i> Bluesky
                </a>
            </div>
        </div>
    </section>

    <section class="gallery-section">
        <div class="container">
            <div class="masonry-grid">
                {photos.map((photo) => (
                <div class="masonry-item reveal">
                    <a href={photo.full} class="lightbox-trigger"
                        data-caption={`<strong>${photo.title}</strong>
                        ${photo.description} <br>
                        <span class="meta">${photo.camera} &bull; ${photo.date}</span>`}
                        >
                        <img src={photo.thumb} alt={photo.title} loading="lazy" />
                        <div class="photo-overlay">
                            <span class="category-badge">{photo.category}</span>
                        </div>
                    </a>
                </div>
                ))}
            </div>
        </div>
    </section>

</Layout>

<style>
    /* NOTE: .page-header and typography are now in global.css */

    /* Grid Layout */
    .masonry-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        padding: 4rem 0;
    }

    @media (min-width: 768px) {
        .masonry-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .masonry-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .masonry-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        min-height: 200px;
        background-color: #1f1f1f;
    }

    .masonry-item img {
        width: 100%;
        display: block;
        transition: transform 0.5s ease;
    }

    /* Hover Effects */
    .masonry-item:hover img {
        transform: scale(1.03);
    }

    .photo-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: flex-end;
        padding: 1.5rem;
    }

    .masonry-item:hover .photo-overlay {
        opacity: 1;
    }

    .category-badge {
        background: var(--accent);
        color: #000;
        padding: 0.3rem 0.8rem;
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: bold;
        border-radius: 4px;
    }

    /* Lightbox Watermark */
    :global(.sl-watermark) {
        position: absolute;
        top: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        height: 25px !important;
        width: auto !important;
        z-index: 10000;
        opacity: 0.4;
        pointer-events: none;
    }

    @media (max-width: 768px) {
        :global(.sl-watermark) {
            height: 15px !important;
        }
    }   
</style>

<script>
    declare var SimpleLightbox: any;
    let lightbox: any = null;

    function initLightbox() {
        const gallerySelector = '.masonry-grid a.lightbox-trigger';
        if (!document.querySelector(gallerySelector)) {
            return;
        }

        if (lightbox) {
            lightbox.destroy();
            lightbox = null;
        }

        lightbox = new SimpleLightbox(gallerySelector, {
            captionsData: 'data-caption',
            captionSelector: 'self',
            captionDelay: 0,
            disableScroll: false,
        });

        const hideCaption = () => {
            const caption = document.querySelector('.sl-caption');
            if (caption instanceof HTMLElement) {
                caption.style.opacity = '0'; 
            }
        };

        const showCaption = () => {
            const caption = document.querySelector('.sl-caption');
            if (caption instanceof HTMLElement) {
                // This small delay gives the library a moment to update the caption's innerHTML
                // before we fade it in, preventing a flash of old content.
                setTimeout(() => {
                    caption.style.transition = 'opacity 0.1s'; 
                    caption.style.opacity = '1'; 
                }, 50);
            }
        };

        // Watermark Logic
        const addWatermark = () => {
            const imgContainer = document.querySelector('.sl-image');
            if (imgContainer && !imgContainer.querySelector('.sl-watermark')) {
                const img = document.createElement('img');
                img.src = '/assets/img/watermark.png';
                img.className = 'sl-watermark';
                img.alt = 'Watermark';
                imgContainer.appendChild(img);
            }
        };

        // --- Caption Race Condition Fix ---
        // 1. Hide caption on any action that starts a change
        lightbox.on('open.simplelightbox', hideCaption);
        lightbox.on('next.simplelightbox', hideCaption);
        lightbox.on('prev.simplelightbox', hideCaption);

        // 2. Show caption only after the image is loaded and ready
        lightbox.on('opened.simplelightbox', showCaption);
        lightbox.on('nextImageLoaded.simplelightbox', showCaption);
        lightbox.on('prevImageLoaded.simplelightbox', showCaption);

        // Attach Watermark Events
        lightbox.on('opened.simplelightbox', addWatermark);
        lightbox.on('nextImageLoaded.simplelightbox', addWatermark);
        lightbox.on('prevImageLoaded.simplelightbox', addWatermark);
    }

    function destroyLightbox() {
        if (lightbox) {
            lightbox.destroy();
            lightbox = null;
        }
    }

    // --- Astro View Transitions Lifecycle ---
    document.addEventListener('astro:page-load', initLightbox);
    document.addEventListener('astro:before-swap', destroyLightbox);
</script>